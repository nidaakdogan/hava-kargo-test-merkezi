import React, { useState, useEffect } from 'react'
import { useNotification } from '../../contexts/NotificationContext'
import { useOffline } from '../../contexts/OfflineContext'
import { Smartphone, Clock, CheckCircle, XCircle } from 'lucide-react'
import './MobileBarcode.css'

const MobileBarcode = () => {
  // üéØ TEK DURUM MODELƒ∞ - 4 Ana State (Spesifikasyona g√∂re)
  const [offline, setOffline] = useState(false)  // true/false
  const [Q, setQ] = useState(0)                  // kuyruk: int (status=queued adedi)
  const [P, setP] = useState(0)                  // i≈üleniyor: int (status=processing adedi)
  const [T, setT] = useState(0)                  // toplam: int (status=done ve today(createdAt) adedi)

  // RunId tracking
  const [currentRunId, setCurrentRunId] = useState(null)
  
  // Worker durumu - idle | running | paused
  const [workerState, setWorkerState] = useState('idle')
  
  // Saya√ß g√ºncelleme fonksiyonu - depodan yeniden okuma
  const updateCountersFromStorage = async () => {
    try {
      // Kuyruk: status=queued adedi
      const queueData = JSON.parse(localStorage.getItem('offline_queue') || '[]')
      const queuedCount = queueData.filter(item => item.status === 'queued').length
      setQ(queuedCount)
      
      // ƒ∞≈üleniyor: status=processing adedi
      const processingCount = queueData.filter(item => item.status === 'processing').length
      setP(processingCount)
      
      // Toplam: status=done ve bug√ºn tamamlanan
      const today = new Date().toDateString()
      const doneCount = queueData.filter(item => 
        item.status === 'done' && 
        new Date(item.completedAt).toDateString() === today
      ).length
      setT(doneCount)
      
      console.log(`üìä Saya√ßlar g√ºncellendi: Q=${queuedCount}, P=${processingCount}, T=${doneCount}`)
    } catch (error) {
      console.error('Saya√ß g√ºncelleme hatasƒ±:', error)
    }
  }

  // Yardƒ±mcƒ± state (UI i√ßin)
  const [queueItems, setQueueItems] = useState([])
  const [showClearModal, setShowClearModal] = useState(false)
  const [eventLog, setEventLog] = useState([])

  const [expandedStep, setExpandedStep] = useState(null)
  
  // Sim√ºlasyon paneli state'leri
  const [showSimulationPanel, setShowSimulationPanel] = useState(false)
  const [simulationInput, setSimulationInput] = useState('')
  const [simulationError, setSimulationError] = useState('')
  const [lastScannedBarcodes, setLastScannedBarcodes] = useState([]) // Tekrarlƒ± okuma korumasƒ± i√ßin
  
  // Durum makinesi state'leri
  const [testPhase, setTestPhase] = useState('IDLE') // IDLE, WEB_RUNNING, WEB_SUCCESS, WEB_FAILED, MOBILE_READY, MOBILE_RUNNING, MOBILE_SUCCESS, MOBILE_FAILED, FINISHED
  const [mobileStep, setMobileStep] = useState(0) // 0: Ba≈ülat, 1: Barkod Se√ß, 2: Offline A√ßƒ±k+Kuyruƒüa Ekle, 3: Offline Kapalƒ±+Kuyruƒüu ƒ∞≈üle, 4: Temizlik/Doƒürulama
  const [mobileStepStatus, setMobileStepStatus] = useState('') // SUCCESS, FAILED, RUNNING
  const [mobileStepError, setMobileStepError] = useState('') // Hata detayƒ±
  const [isMobileTestRunning, setIsMobileTestRunning] = useState(false) // Tek runner korumasƒ±
  const [selectedBarcode, setSelectedBarcode] = useState('') // Se√ßilen barkod
  const [initialOfflineState, setInitialOfflineState] = useState(false) // Ba≈ülangƒ±√ßtaki offline durumu
  
  // Debounce koruma - √ßift tƒ±klama √∂nleme
  const [lastActionTime, setLastActionTime] = useState(0)
  const DEBOUNCE_DELAY = 300 // 300ms
  
  // Debounce check fonksiyonu
  const checkDebounce = () => {
    const now = Date.now()
    if (now - lastActionTime < DEBOUNCE_DELAY) {
      return false
    }
    setLastActionTime(now)
    return true
  }
  
  // Notification context
  const { showSuccess, showError, showInfo } = useNotification()

  // Event log fonksiyonu
  const addEventLog = (message, type = 'info') => {
    const timestamp = new Date().toLocaleTimeString('tr-TR')
    setEventLog(prev => [...prev, { timestamp, message, type }])
  }

  // Detaylƒ± loglama fonksiyonu
  const addDetailedLog = (phase, step, action, result, detail = '') => {
    const timestamp = new Date().toISOString()
    const logEntry = `${timestamp} | ${phase} | ${step} | ${action} | ${result} | ${detail}`
    console.log(logEntry)
    addEventLog(logEntry, result === 'SUCCESS' ? 'success' : result === 'FAILED' ? 'error' : 'info')
  }

  // Durum makinesi fonksiyonlarƒ±
  const updateTestPhase = (newPhase) => {
    const oldPhase = testPhase
    setTestPhase(newPhase)
    addDetailedLog('STATE', 'PHASE', 'CHANGE', 'SUCCESS', `${oldPhase} ‚Üí ${newPhase}`)
  }

  const updateMobileStep = (step, status, error = '') => {
    setMobileStep(step)
    setMobileStepStatus(status)
    setMobileStepError(error)
    addDetailedLog('MOBILE', `STEP_${step}`, status, status, error)
  }

  // Web testi tamamlandƒ±ƒüƒ±nda √ßaƒürƒ±lacak
  const onWebTestCompleted = (success) => {
    if (success) {
      updateTestPhase('MOBILE_READY')
      showSuccess('Web testi tamamlandƒ±. Mobil testine ge√ßebilirsiniz.')
    } else {
      updateTestPhase('WEB_FAILED')
      showError('Web testi ba≈üarƒ±sƒ±z. Mobil test ba≈ülatƒ±lamaz.')
    }
  }

  // Dashboard g√ºncelleme fonksiyonu
  const updateDashboard = async (validCount = 0, invalidCount = 0) => {
    try {
      // WebSocket ile dashboard'a veri g√∂nder
      const ws = new WebSocket('ws://localhost:3001')
      ws.onopen = () => {
        ws.send(JSON.stringify({
          type: 'mobile_test_results',
          valid: validCount,
          invalid: invalidCount,
          timestamp: new Date().toISOString()
        }))
        ws.close()
      }
    } catch (error) {
      console.error('Dashboard g√ºncelleme hatasƒ±:', error)
    }
  }

  // Mobil testi ba≈ülat
  const handleMobileTestStart = async () => {
    if (isMobileTestRunning) {
      showError('Mobil test zaten √ßalƒ±≈üƒ±yor.')
      return
    }

    if (testPhase !== 'MOBILE_READY') {
      showError('Mobil test ba≈ülatƒ±lamaz. Web testi √∂nce tamamlanmalƒ±.')
      return
    }

    setIsMobileTestRunning(true)
    updateTestPhase('MOBILE_RUNNING')
    updateMobileStep(0, 'RUNNING')

    try {
      // Adƒ±m 1: Ba≈ülat/√ñnko≈üullar
      await executeMobileStep1()
    } catch (error) {
      handleMobileTestError(0, error.message)
    }
  }

  // Adƒ±m 1: Ba≈ülat/√ñnko≈üullar
  const executeMobileStep1 = async () => {
    addDetailedLog('MOBILE', 'STEP_1', 'PRECHECKS', 'RUNNING', 'Ba≈ülat/√ñnko≈üullar kontrol√º')
    
    // √ñnko≈üul 1: Kuyruk temiz mi?
    if (Q > 0) {
      const shouldClean = window.confirm(`Kuyrukta ${Q} kayƒ±t var. Temizleyelim mi?`)
      if (shouldClean) {
        setQ(0)
        setQueueItems([])
        addDetailedLog('MOBILE', 'STEP_1', 'CLEAN_QUEUE', 'SUCCESS', `${Q} kayƒ±t temizlendi`)
      } else {
        throw new Error('Kuyruk temizlenmedi')
      }
    }

    // √ñnko≈üul 2: Offline durumunu not et
    setInitialOfflineState(offline)
    addDetailedLog('MOBILE', 'STEP_1', 'SAVE_OFFLINE_STATE', 'SUCCESS', `Offline: ${offline}`)

    updateMobileStep(1, 'SUCCESS')
    showInfo('Adƒ±m 1 tamamlandƒ±. Barkod se√ßimi i√ßin hazƒ±r.')
    
    // Adƒ±m 2'ye ge√ß
    setTimeout(() => executeMobileStep2(), 1000)
  }

  // Adƒ±m 2: Barkod Se√ß/Gir
  const executeMobileStep2 = async () => {
    addDetailedLog('MOBILE', 'STEP_2', 'BARKOD_SELECT', 'RUNNING', 'Barkod se√ßimi bekleniyor')
    updateMobileStep(2, 'RUNNING')
    
    // Sim√ºlasyon panelini a√ß
    setShowSimulationPanel(true)
    
    // Barkod se√ßimi i√ßin event listener ekle
    const handleBarcodeSelection = (barcode) => {
      setSelectedBarcode(barcode)
      updateMobileStep(2, 'SUCCESS', `Se√ßildi: ${barcode}`)
      showSuccess(`Se√ßildi: ${barcode}`)
      
      // Event listener'ƒ± kaldƒ±r
      document.removeEventListener('barcodeSelected', handleBarcodeSelection)
      
      // Adƒ±m 3'e ge√ß
      setTimeout(() => executeMobileStep3(), 1000)
    }
    
    document.addEventListener('barcodeSelected', handleBarcodeSelection)
  }

  // Adƒ±m 3: Offline = A√áIK iken Kuyruƒüa Ekle
  const executeMobileStep3 = async () => {
    addDetailedLog('MOBILE', 'STEP_3', 'OFFLINE_QUEUE', 'RUNNING', 'Offline moda ge√ßi≈ü ve kuyruƒüa ekleme')
    updateMobileStep(3, 'RUNNING')
    
    try {
      // Offline modu a√ß
      setOffline(true)
      addDetailedLog('MOBILE', 'STEP_3', 'SET_OFFLINE', 'SUCCESS', 'Offline modu a√ßƒ±ldƒ±')
      
      // Barkod sim√ºlasyonu - kuyruƒüa ekle
      const validation = validateBarcode(selectedBarcode)
      if (!validation.valid) {
        throw new Error(`Ge√ßersiz barkod: ${validation.error}`)
      }

      // Kuyruƒüa ekle
      const newQ = Q + 1
      setQ(newQ)
      
      const newItem = {
        id: Date.now(),
        barcode: selectedBarcode,
        timestamp: new Date().toISOString(),
        status: 'pending'
      }
      setQueueItems(prev => [...prev, newItem])
      
      addDetailedLog('MOBILE', 'STEP_3', 'ADD_TO_QUEUE', 'SUCCESS', `Kuyruk: ${Q} ‚Üí ${newQ}`)
      showSuccess('Offline: kuyruƒüa eklendi')
      
      updateMobileStep(3, 'SUCCESS')
      
      // Adƒ±m 4'e ge√ß
      setTimeout(() => executeMobileStep4(), 1000)
    } catch (error) {
      throw new Error(`Adƒ±m 3 hatasƒ±: ${error.message}`)
    }
  }

  // Adƒ±m 4: Offline = KAPALI + "Kuyruƒüu ƒ∞≈üle"
  const executeMobileStep4 = async () => {
    addDetailedLog('MOBILE', 'STEP_4', 'ONLINE_PROCESS', 'RUNNING', 'Online moda ge√ßi≈ü ve kuyruk i≈üleme')
    updateMobileStep(4, 'RUNNING')
    
    try {
      // Offline modu kapat
      setOffline(false)
      addDetailedLog('MOBILE', 'STEP_4', 'SET_ONLINE', 'SUCCESS', 'Online modu a√ßƒ±ldƒ±')
      
      // Kuyruƒüu i≈üle (geli≈ütirilmi≈ü fonksiyonu kullan)
      if (Q === 0) {
        throw new Error('Kuyruk bo≈ü - i≈ülenecek kayƒ±t yok')
      }
      
      addDetailedLog('MOBILE', 'STEP_4', 'START_PROCESSING', 'SUCCESS', `ƒ∞≈üleniyor: ${Q}`)
      showInfo('Kuyruk i≈üleniyor...')
      
      // Worker kilidini kontrol et
      if (isProcessingQueue) {
        throw new Error('Worker zaten √ßalƒ±≈üƒ±yor')
      }
      
      // Kuyruƒüu i≈üle (tek tek)
      const itemsToProcess = [...queueItems]
      let successCount = 0
      let failCount = 0
      
      for (const item of itemsToProcess) {
        try {
          const response = await fetch('http://localhost:3001/api/barcode-scanned', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              runId: currentRunId,
              code: item.barcode,
              mode: 'online'
            })
          })
          
          const result = await response.json()
          
          if (result.success) {
            successCount++
          } else {
            failCount++
          }
        } catch (error) {
          failCount++
        }
      }
      
      // Sonu√ßlarƒ± i≈üle
      const newT = T + successCount
      setT(newT)
      setP(0)
      setQ(0)
      setQueueItems([])
      
      addDetailedLog('MOBILE', 'STEP_4', 'PROCESS_COMPLETE', 'SUCCESS', `Ba≈üarƒ±lƒ±: ${successCount}, Ba≈üarƒ±sƒ±z: ${failCount}`)
      showSuccess(`Kuyruk i≈ülendi: ${successCount} ba≈üarƒ±lƒ±, ${failCount} ba≈üarƒ±sƒ±z`)
      
      updateMobileStep(4, 'SUCCESS')
      
      // Adƒ±m 5'e ge√ß
      setTimeout(() => executeMobileStep5(), 1000)
    } catch (error) {
      setP(0)
      throw new Error(`Adƒ±m 4 hatasƒ±: ${error.message}`)
    }
  }

  // Adƒ±m 5: Temizlik/Doƒürulama
  const executeMobileStep5 = async () => {
    addDetailedLog('MOBILE', 'STEP_5', 'CLEANUP_VERIFY', 'RUNNING', 'Temizlik ve doƒürulama')
    updateMobileStep(5, 'RUNNING')
    
    try {
      // Doƒürulama: Kuyruk 0, ƒ∞≈üleniyor 0, Toplam ‚â• 1
      if (Q !== 0) {
        throw new Error(`Kuyruk sƒ±fƒ±rlanmadƒ±: ${Q}`)
      }
      if (P !== 0) {
        throw new Error(`ƒ∞≈üleniyor sƒ±fƒ±rlanmadƒ±: ${P}`)
      }
      if (T < 1) {
        throw new Error(`Toplam artmadƒ±: ${T}`)
      }
      
      addDetailedLog('MOBILE', 'STEP_5', 'VERIFY_COUNTERS', 'SUCCESS', `Kuyruk: ${Q}, ƒ∞≈üleniyor: ${P}, Toplam: ${T}`)
      showSuccess('Kuyruk i≈ülendi ve temizlendi')
      
      updateMobileStep(5, 'SUCCESS')
      updateTestPhase('MOBILE_SUCCESS')
      setIsMobileTestRunning(false)
      
      showSuccess('Mobil test ba≈üarƒ±yla tamamlandƒ±!')
    } catch (error) {
      throw new Error(`Adƒ±m 5 hatasƒ±: ${error.message}`)
    }
  }

  // Mobil test hatasƒ±
  const handleMobileTestError = (step, error) => {
    updateMobileStep(step, 'FAILED', error)
    updateTestPhase('MOBILE_FAILED')
    setIsMobileTestRunning(false)
    showError(`Mobil test hatasƒ± - Adƒ±m ${step}: ${error}`)
  }

  // Mobil testi bitir
  const handleMobileTestComplete = async () => {
    if (testPhase === 'MOBILE_SUCCESS') {
    try {
        // Backend'e g√∂nder
      const response = await fetch('http://localhost:3001/api/mobile-test-completed', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          runId: currentRunId
        })
      })
      
      const result = await response.json()
      
      if (result.success) {
          updateTestPhase('FINISHED')
        showSuccess('Mobil test tamamlandƒ±.')
          addDetailedLog('MOBILE', 'COMPLETE', 'FINISH', 'SUCCESS', 'Test tamamlandƒ±')
      } else {
        throw new Error('Mobil test tamamlanamadƒ±')
      }
    } catch (error) {
      console.error('Mobil test tamamlama hatasƒ±:', error)
      showError('Mobil test tamamlanamadƒ±.')
        addDetailedLog('MOBILE', 'COMPLETE', 'FINISH', 'FAILED', error.message)
      }
    } else {
      // Hata durumunda testi sonlandƒ±r
      updateTestPhase('FINISHED')
      showError('Test sonlandƒ±rƒ±ldƒ± (hata var)')
    }
  }


  // Barkod doƒürulama fonksiyonu - Geli≈ütirilmi≈ü
  const validateBarcode = (barcode) => {
    const cleanBarcode = (barcode || '').trim().toUpperCase()
    
    // Bo≈ü veya √ßok kƒ±sa kontrol√º
    if (!cleanBarcode || cleanBarcode.length < 5) {
      return { valid: false, error: 'Barkod √ßok kƒ±sa (minimum 5 karakter)' }
    }
    
    // Yasaklƒ± karakter kontrol√º
    if (!/^[A-Z0-9\-_]+$/.test(cleanBarcode)) {
      return { valid: false, error: 'Ge√ßersiz karakterler i√ßeriyor' }
    }
    
    // Format kontrolleri
    const uldRegex = /^ULD-[A-Z]{3}\d{5}[A-Z]{2}$/
    const awbRegex = /^\d{3}-\d{8}$/
    const testRegex = /^TEST-\d{5}$/
    const uldTestRegex = /^ULD-TEST\d+$/
    const eanRegex = /^\d{12,13}$/
    const code128Regex = /^[A-Z0-9]{8,20}$/
    
    const isValid = uldRegex.test(cleanBarcode) || awbRegex.test(cleanBarcode) || 
                   testRegex.test(cleanBarcode) || uldTestRegex.test(cleanBarcode) ||
                   eanRegex.test(cleanBarcode) || code128Regex.test(cleanBarcode)
    
    return { 
      valid: isValid, 
      error: isValid ? null : 'Ge√ßersiz barkod formatƒ±' 
    }
  }

  // Tekrarlƒ± okuma korumasƒ±
  const checkDuplicateBarcode = (barcode) => {
    const now = Date.now()
    const DUPLICATE_WINDOW = 5000 // 5 saniye
    
    // Eski kayƒ±tlarƒ± temizle (5 saniyeden eski)
    const recentBarcodes = lastScannedBarcodes.filter(item => 
      now - item.timestamp < DUPLICATE_WINDOW
    )
    
    // Aynƒ± barkod var mƒ± kontrol et
    const isDuplicate = recentBarcodes.some(item => item.barcode === barcode)
    
    if (isDuplicate) {
      return { isDuplicate: true, message: 'Zaten okundu' }
    }
    
    // Yeni barkodu listeye ekle
    setLastScannedBarcodes(prev => [
      ...recentBarcodes,
      { barcode, timestamp: now }
    ])
    
    return { isDuplicate: false }
  }

  // Rastgele ge√ßerli barkod √ºret
  const generateValidBarcode = () => {
    const types = [
      () => `ULD-${String.fromCharCode(65 + Math.floor(Math.random() * 26))}${String.fromCharCode(65 + Math.floor(Math.random() * 26))}${String.fromCharCode(65 + Math.floor(Math.random() * 26))}${Math.floor(Math.random() * 100000).toString().padStart(5, '0')}${String.fromCharCode(65 + Math.floor(Math.random() * 26))}${String.fromCharCode(65 + Math.floor(Math.random() * 26))}`,
      () => `${Math.floor(Math.random() * 1000).toString().padStart(3, '0')}-${Math.floor(Math.random() * 100000000).toString().padStart(8, '0')}`,
      () => `TEST-${Math.floor(Math.random() * 100000).toString().padStart(5, '0')}`,
      () => `ULD-TEST${Math.floor(Math.random() * 10000)}`,
      () => Math.floor(Math.random() * 10000000000000).toString().padStart(13, '0'),
      () => Math.random().toString(36).substring(2, 15).toUpperCase()
    ]
    
    const randomType = types[Math.floor(Math.random() * types.length)]
    return randomType()
  }

  // Rastgele ge√ßersiz barkod √ºret
  const generateInvalidBarcode = () => {
    const invalidTypes = [
      'TOO-SHORT',
      'VERY-LONG-INVALID-BARCODE-FORMAT',
      'INVALID@CHAR',
      '123',
      'INVALID-FORMAT-123',
      'BAD-CHECKSUM-12345'
    ]
    
    return invalidTypes[Math.floor(Math.random() * invalidTypes.length)]
  }

  // Hazƒ±r barkod listesi - Geni≈ületilmi≈ü
  const getPredefinedBarcodes = () => [
    // Ge√ßerli barkodlar
    { code: 'ULD-AKE12345AB', type: 'ULD', valid: true },
    { code: 'ULD-BCD67890CD', type: 'ULD', valid: true },
    { code: 'ULD-EFG90123EF', type: 'ULD', valid: true },
    { code: '123-45678901', type: 'AWB', valid: true },
    { code: '456-78901234', type: 'AWB', valid: true },
    { code: '789-01234567', type: 'AWB', valid: true },
    { code: 'TEST-12345', type: 'TEST', valid: true },
    { code: 'TEST-67890', type: 'TEST', valid: true },
    { code: 'ULD-TEST123', type: 'ULD-TEST', valid: true },
    { code: 'ULD-TEST456', type: 'ULD-TEST', valid: true },
    { code: '1234567890123', type: 'EAN', valid: true },
    { code: '9876543210987', type: 'EAN', valid: true },
    { code: 'ABC123DEF456', type: 'CODE128', valid: true },
    { code: 'XYZ789GHI012', type: 'CODE128', valid: true },
    
    // Ge√ßersiz barkodlar (Negatif test i√ßin)
    { code: 'INVALID-123', type: 'ERR', valid: false },
    { code: 'BAD-FORMAT', type: 'ERR', valid: false },
    { code: 'TOO-SHORT', type: 'ERR', valid: false },
    { code: 'WRONG@CHAR', type: 'ERR', valid: false },
    { code: 'EMPTY', type: 'ERR', valid: false }
  ]

  // A) Toggle (Offline Modu) - SPESƒ∞Fƒ∞KASYON
  const handleOfflineModeToggle = () => {
    if (!checkDebounce()) {
      return
    }

    const newOfflineMode = !offline

    // 1. State'i g√ºncelle (sadece offline, saya√ßlara dokunma)
    setOffline(newOfflineMode)

    // 2. UI g√ºncelleme (buton aktifliklerini yenile)
    // 3. Toast g√∂ster - detaylƒ± mesajlar
    if (newOfflineMode) {
      showSuccess('Offline moda ge√ßildi ‚Äì barkodlar kuyruƒüa eklenecek.')
    } else {
      showSuccess('Online moda ge√ßildi ‚Äì barkodlar direkt i≈ülenecek.')
    }
  }

  // B) Barkod Tara / Oku - SPESƒ∞Fƒ∞KASYON (Sim√ºlasyon)
  const handleBarcodeScan = async (barcode) => {
    if (!checkDebounce()) return

    console.log(`üîÑ B) Barkod Tara: offline=${offline}, barcode=${barcode}`)

    // Tekrarlƒ± okuma korumasƒ±
    const duplicateCheck = checkDuplicateBarcode(barcode)
    if (duplicateCheck.isDuplicate) {
      showError(duplicateCheck.message)
      addEventLog(`duplicate_barcode: ${barcode}`, 'warning')
      return
    }

    // Barkod doƒürula (format)
    const validation = validateBarcode(barcode)
    
    if (!validation.valid) {
      showError(`Ge√ßersiz barkod ‚Äì i≈ülem yapƒ±lmadƒ±: ${validation.error}`)
      addEventLog(`validation_error: ${barcode} - ${validation.error}`, 'error')
      return
    }

    if (offline) {
      // offline=true (ye≈üil): Ge√ßerliyse Q = Q + 1. (P ve T deƒüi≈ümez)
      // Kuyruƒüa ekle (depoya kaydet)
      const newItem = {
        id: Date.now(),
        barcode,
        timestamp: new Date().toISOString(),
        status: 'queued',
        createdAt: new Date().toISOString()
      }
      
      // Depoya kaydet
      const queueData = JSON.parse(localStorage.getItem('offline_queue') || '[]')
      queueData.push(newItem)
      localStorage.setItem('offline_queue', JSON.stringify(queueData))
      
      // Saya√ßlarƒ± depodan g√ºncelle
      await updateCountersFromStorage()
      
      // UI i√ßin g√ºncelle
      setQueueItems(prev => [...prev, newItem])

      showSuccess('Offline: kuyruƒüa eklendi')
      addEventLog(`queued: ${barcode}`, 'success')
    } else {
      // offline=false (gri): ONLINE mod - anƒ±nda i≈üleme
      // ƒ∞≈üleniyor sayacƒ±nƒ± g√ºncelle
      setP(1)
      console.log(`üîÑ Online: P=0 ‚Üí 1 (i≈ülem ba≈üladƒ±)`)
      
      try {
        // 5) Mobil Barkod - ONLINE - Backend'e g√∂nder
        const response = await fetch('http://localhost:3001/api/barcode-scanned', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            runId: currentRunId,
            code: barcode,
            mode: 'online'
          })
        })
        
        const result = await response.json()
        
        if (result.success) {
          // Ba≈üarƒ±lƒ± ‚Üí T = T + 1, P = 0
          const newItem = {
            id: Date.now(),
            barcode,
            timestamp: new Date().toISOString(),
            status: 'done',
            completedAt: new Date().toISOString()
          }
          
          // Depoya kaydet
          const queueData = JSON.parse(localStorage.getItem('offline_queue') || '[]')
          queueData.push(newItem)
          localStorage.setItem('offline_queue', JSON.stringify(queueData))
          
          // Saya√ßlarƒ± depodan g√ºncelle
          await updateCountersFromStorage()
          
          showSuccess(`G√∂nderildi: ${barcode}`)
          addEventLog(`barcode_success: ${barcode}`, 'success')
          updateDashboard(1, 0)
        } else {
          // Hatalƒ± ‚Üí T deƒüi≈ümez, P = 0
          setP(0)
          showError('Ge√ßersiz barkod ‚Äì i≈ülenmedi')
          addEventLog(`barcode_fail: ${barcode}`, 'error')
          updateDashboard(0, 1)
        }
      } catch (error) {
        setP(0)
        
        // Sebep bazlƒ± hata mesajlarƒ±
        if (error.message.includes('Ge√ßersiz barkod')) {
          showError('Ge√ßersiz barkod ‚Äì i≈ülenmedi')
        } else if (error.message.includes('Zaten okundu')) {
          showError('Zaten okundu')
        } else if (error.message.includes('Offline a√ßƒ±kken')) {
          showError('Offline a√ßƒ±kken i≈üleme yapƒ±lamaz')
        } else {
          showError(`Sunucuya ula≈üƒ±lamadƒ± ‚Äì tekrar denenecek (2/3)`)
        }
        
        addEventLog(`barcode_error: ${barcode}`, 'error')
      }
    }
  }

  // Sim√ºlasyon paneli fonksiyonlarƒ±
  const openSimulationPanel = () => {
    if (!checkDebounce()) return
    setShowSimulationPanel(true)
    setSimulationInput('')
    setSimulationError('')
  }

  const closeSimulationPanel = () => {
    setShowSimulationPanel(false)
    setSimulationInput('')
    setSimulationError('')
  }

  const handleGenerateValid = () => {
    const barcode = generateValidBarcode()
    showInfo(`√úretildi: ${barcode}`)
    addEventLog(`generated_valid: ${barcode}`, 'info')
    
    // Mobil test akƒ±≈üƒ±nda mƒ± kontrol et
    if (isMobileTestRunning && mobileStep === 2) {
      // Event tetikle
      document.dispatchEvent(new CustomEvent('barcodeSelected', { detail: barcode }))
    } else {
      // Normal akƒ±≈ü
      handleBarcodeScan(barcode)
    }
    closeSimulationPanel()
  }

  const handleGenerateInvalid = () => {
    const barcode = generateInvalidBarcode()
    showInfo(`√úretildi: ${barcode}`)
    addEventLog(`generated_invalid: ${barcode}`, 'info')
    
    // Mobil test akƒ±≈üƒ±nda mƒ± kontrol et
    if (isMobileTestRunning && mobileStep === 2) {
      // Event tetikle
      document.dispatchEvent(new CustomEvent('barcodeSelected', { detail: barcode }))
    } else {
      // Normal akƒ±≈ü
      handleBarcodeScan(barcode)
    }
    closeSimulationPanel()
  }

  const handleSelectPredefined = (barcode) => {
    addEventLog(`selected_predefined: ${barcode}`, 'info')
    
    // Mobil test akƒ±≈üƒ±nda mƒ± kontrol et
    if (isMobileTestRunning && mobileStep === 2) {
      // Event tetikle
      document.dispatchEvent(new CustomEvent('barcodeSelected', { detail: barcode }))
    } else {
      // Normal akƒ±≈ü
      handleBarcodeScan(barcode)
    }
    closeSimulationPanel()
  }

  const handleManualSubmit = () => {
    const barcode = simulationInput.trim().toUpperCase()
    if (!barcode) {
      setSimulationError('Barkod giriniz')
      return
    }
    
    addEventLog(`manual_input: ${barcode}`, 'info')
    
    // Mobil test akƒ±≈üƒ±nda mƒ± kontrol et
    if (isMobileTestRunning && mobileStep === 2) {
      // Event tetikle
      document.dispatchEvent(new CustomEvent('barcodeSelected', { detail: barcode }))
    } else {
      // Normal akƒ±≈ü
      handleBarcodeScan(barcode)
    }
    closeSimulationPanel()
  }

  // C) Kuyruƒüu ƒ∞≈üle - GELƒ∞≈ûTƒ∞Rƒ∞LMƒ∞≈û (Tek worker kilidi, atomik durum ge√ßi≈üi, retry politikasƒ±)
  const [queueRetryCount, setQueueRetryCount] = useState(0) // Retry sayacƒ±
  const [queueRetrySchedule, setQueueRetrySchedule] = useState(null) // Retry zamanlayƒ±cƒ±sƒ±
  const [failedItems, setFailedItems] = useState([]) // Ba≈üarƒ±sƒ±z √∂ƒüeler
  
  // Watchdog ve lease sistemi
  const [processingItems, setProcessingItems] = useState(new Map()) // leaseId -> {item, startedAt, timeoutId}
  const [watchdogTimers, setWatchdogTimers] = useState(new Map()) // leaseId -> timeoutId
  
  // Watchdog timer - 20 saniye maksimum s√ºre
  const WATCHDOG_TIMEOUT = 20000 // 20 saniye
  
  // Atomic lease sistemi - √∂ƒüeyi queued'dan processing'e al
  const acquireLease = (item) => {
    const leaseId = `lease_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
    const startedAt = Date.now()
    
    // Watchdog timer ba≈ülat
    const timeoutId = setTimeout(() => {
      handleWatchdogTimeout(leaseId)
    }, WATCHDOG_TIMEOUT)
    
    // Lease'i kaydet
    setProcessingItems(prev => {
      const newMap = new Map(prev)
      newMap.set(leaseId, { item, startedAt, timeoutId })
      return newMap
    })
    
    setWatchdogTimers(prev => {
      const newMap = new Map(prev)
      newMap.set(leaseId, timeoutId)
      return newMap
    })
    
    addDetailedLog('QUEUE', 'acquireLease', 'SUCCESS', 'SUCCESS', `id=${item.id}, leaseId=${leaseId}`)
    return leaseId
  }
  
  // Lease'i serbest bƒ±rak
  const releaseLease = (leaseId) => {
    // Timer'ƒ± temizle
    const timeoutId = watchdogTimers.get(leaseId)
    if (timeoutId) {
      clearTimeout(timeoutId)
      setWatchdogTimers(prev => {
        const newMap = new Map(prev)
        newMap.delete(leaseId)
        return newMap
      })
    }
    
    // Lease'i kaldƒ±r
    setProcessingItems(prev => {
      const newMap = new Map(prev)
      newMap.delete(leaseId)
      return newMap
    })
    
    addDetailedLog('QUEUE', 'releaseLease', 'SUCCESS', 'SUCCESS', `leaseId=${leaseId}`)
  }
  
  // Watchdog timeout handler
  const handleWatchdogTimeout = (leaseId) => {
    const processingItem = processingItems.get(leaseId)
    if (!processingItem) return
    
    const { item, startedAt } = processingItem
    const age = Date.now() - startedAt
    
    addDetailedLog('QUEUE', 'watchdogTimeout', 'FAILED', 'FAILED', `id=${item.id}, leaseId=${leaseId}, age=${age}ms`)
    
    // √ñƒüeyi tekrar queued yap
    setQueueItems(prev => [...prev, { ...item, status: 'queued' }])
    setQ(prev => prev + 1)
    
    // Lease'i serbest bƒ±rak
    releaseLease(leaseId)
    
    showError(`Barkod i≈üleme zaman a≈üƒ±mƒ±: ${item.barcode} (${Math.round(age/1000)}s)`)
  }
  
  // Uzla≈üma sistemi - uygulama a√ßƒ±lƒ±≈üƒ±nda takƒ±lƒ± processing √∂ƒüeleri temizle
  const reconcileProcessingItems = async () => {
    const now = Date.now()
    const WATCHDOG_TIMEOUT = 20000 // 20 saniye
    
    // Depodan processing kayƒ±tlarƒ± al
    const queueData = JSON.parse(localStorage.getItem('offline_queue') || '[]')
    const stuckItems = []
    
    queueData.forEach(item => {
      if (item.status === 'processing' && item.startedAt) {
        const age = now - new Date(item.startedAt).getTime()
        
        if (age > WATCHDOG_TIMEOUT) {
          stuckItems.push(item)
        }
      }
    })
    
    if (stuckItems.length > 0) {
      addDetailedLog('QUEUE', 'reconcile', 'SUCCESS', 'SUCCESS', `stuckItems=${stuckItems.length}`)
      
      // Takƒ±lƒ± processing kayƒ±tlarƒ± queued'a d√∂nd√ºr
      const updatedQueueData = queueData.map(item => {
        if (item.status === 'processing' && item.startedAt) {
          const age = now - new Date(item.startedAt).getTime()
          if (age > WATCHDOG_TIMEOUT) {
            return {
              ...item,
              status: 'queued',
              retryCount: (item.retryCount || 0) + 1
            }
          }
        }
        return item
      })
      
      localStorage.setItem('offline_queue', JSON.stringify(updatedQueueData))
      
      // Saya√ßlarƒ± depodan g√ºncelle
      await updateCountersFromStorage()
      
      showInfo(`${stuckItems.length} takƒ±lƒ± √∂ƒüe kuyruƒüa geri alƒ±ndƒ±`)
    }
  }

  // Retry politikasƒ± - Exponential backoff (5s ‚Üí 10s ‚Üí 15s)
  const scheduleRetry = (items, attempt) => {
    const backoffDelays = [5000, 10000, 15000] // 5s, 10s, 15s
    const delay = backoffDelays[attempt - 1] || 15000
    
    addDetailedLog('QUEUE', 'retryScheduled', 'RUNNING', 'SUCCESS', `attempt=${attempt}/3, backoff=${delay}ms`)
    
    const timeoutId = setTimeout(() => {
      setQueueRetryCount(attempt)
      retryFailedItems(items, attempt)
    }, delay)
    
    setQueueRetrySchedule(timeoutId)
    
    // Sebep bazlƒ± retry mesajlarƒ±
    if (attempt === 1) {
      showInfo(`Sunucuya ula≈üƒ±lamadƒ± ‚Äì tekrar denenecek (1/3) - ${delay/1000}s sonra`)
    } else if (attempt === 2) {
      showInfo(`Sunucuya ula≈üƒ±lamadƒ± ‚Äì tekrar denenecek (2/3) - ${delay/1000}s sonra`)
    } else {
      showInfo(`Sunucu hatasƒ± 5xx ‚Äì tekrar denenecek (3/3) - ${delay/1000}s sonra`)
    }
  }

  // Ba≈üarƒ±sƒ±z √∂ƒüeleri tekrar dene
  const retryFailedItems = async (items, attempt) => {
    if (attempt > 3) {
      addDetailedLog('QUEUE', 'retryExhausted', 'FAILED', 'FAILED', 'Maksimum deneme sayƒ±sƒ± a≈üƒ±ldƒ±')
      showError('3 deneme ba≈üarƒ±sƒ±z - kayƒ±tlar i≈ülenemedi')
      setWorkerState('idle')
      return
    }

    addDetailedLog('QUEUE', 'retryStart', 'RUNNING', 'SUCCESS', `attempt=${attempt}, items=${items.length}`)
    
    let successCount = 0
    let stillFailedItems = []
    
    for (const item of items) {
      try {
        const response = await fetch('http://localhost:3001/api/barcode-scanned', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            runId: currentRunId,
            code: item.barcode,
            mode: 'online'
          })
        })
        
        const result = await response.json()
        
        if (result.success) {
          successCount++
          addDetailedLog('QUEUE', 'retrySuccess', 'SUCCESS', 'SUCCESS', `id=${item.id}, attempt=${attempt}`)
        } else {
          stillFailedItems.push(item)
          addDetailedLog('QUEUE', 'retryFail', 'FAILED', 'FAILED', `id=${item.id}, attempt=${attempt}`)
        }
      } catch (error) {
        stillFailedItems.push(item)
        addDetailedLog('QUEUE', 'retryError', 'FAILED', 'FAILED', `id=${item.id}, attempt=${attempt}, error=${error.message}`)
      }
    }
    
    if (successCount > 0) {
      const newT = T + successCount
      setT(newT)
      showSuccess(`Retry ba≈üarƒ±lƒ±: ${successCount} kayƒ±t i≈ülendi`)
    }
    
    if (stillFailedItems.length > 0) {
      scheduleRetry(stillFailedItems, attempt + 1)
    } else {
      setWorkerState('idle')
      setP(0)
      addDetailedLog('QUEUE', 'retryComplete', 'SUCCESS', 'SUCCESS', 'T√ºm retry i≈ülemleri tamamlandƒ±')
    }
  }

  const handleProcessQueue = async () => {
    // Debounce korumasƒ±
    if (!checkDebounce()) return

    addDetailedLog('QUEUE', 'startProcess', 'RUNNING', 'SUCCESS', `offline=${offline}, queueCount=${Q}`)

    // Koruma 1: Offline a√ßƒ±kken i≈üleme yapƒ±lamaz
    if (offline) {
      addDetailedLog('QUEUE', 'startProcess', 'FAILED', 'FAILED', 'Offline a√ßƒ±kken i≈üleme yapƒ±lamaz')
      showError('Offline a√ßƒ±kken i≈üleme yapƒ±lamaz.')
      return
    }
    
    // Koruma 2: Kuyruk bo≈ü
    if (Q === 0) {
      addDetailedLog('QUEUE', 'startProcess', 'FAILED', 'FAILED', 'ƒ∞≈ülenecek kayƒ±t yok')
      showInfo('ƒ∞≈ülenecek kayƒ±t yok.')
      return
    }
    
    // Koruma 3: Worker idle olmalƒ±
    if (workerState !== 'idle') {
      addDetailedLog('QUEUE', 'startProcess', 'FAILED', 'FAILED', 'Worker zaten √ßalƒ±≈üƒ±yor')
      showError('ƒ∞≈ülem zaten devam ediyor.')
      return
    }

    // Worker durumunu g√ºncelle
    setWorkerState('running')
    addDetailedLog('QUEUE', 'startProcess', 'RUNNING', 'SUCCESS', 'Worker ba≈ülatƒ±ldƒ±')

    try {
      // Atomik durum ge√ßi≈üi: queued ‚Üí processing
      const queueData = JSON.parse(localStorage.getItem('offline_queue') || '[]')
      const itemsToProcess = queueData.filter(item => item.status === 'queued')
      const totalItems = itemsToProcess.length
      
      addDetailedLog('QUEUE', 'takeItem', 'RUNNING', 'SUCCESS', `id=batch, from=queued -> processing, count=${totalItems}`)
      
      // Atomik durum ge√ßi≈üi: queued ‚Üí processing
      const updatedQueueData = queueData.map(item => {
        if (item.status === 'queued') {
          return {
            ...item,
            status: 'processing',
            leaseId: `lease_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            startedAt: new Date().toISOString()
          }
        }
        return item
      })
      
      // Depoya kaydet
      localStorage.setItem('offline_queue', JSON.stringify(updatedQueueData))
      
      // Saya√ßlarƒ± depodan g√ºncelle
      await updateCountersFromStorage()
      
      // Her √∂ƒüeyi tek tek i≈üle (FIFO)
      let successCount = 0
      let failCount = 0
      const failedItems = []

      for (let i = 0; i < itemsToProcess.length; i++) {
        const item = itemsToProcess[i]
        
        // startTime'ƒ± try bloƒüu dƒ±≈üƒ±nda tanƒ±mla
        const startTime = Date.now()
        
        try {
          addDetailedLog('QUEUE', 'request', 'RUNNING', 'SUCCESS', `id=${item.id}, ms=0`)
          
          // Backend'e g√∂nder
          const response = await fetch('http://localhost:3001/api/barcode-scanned', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              runId: currentRunId,
              code: item.barcode,
              mode: 'online'
            })
          })
          
          const result = await response.json()
          const duration = Date.now() - startTime
          
          if (result.success) {
            // Ba≈üarƒ±lƒ± ‚Üí done
            successCount++
            const updatedQueueData = JSON.parse(localStorage.getItem('offline_queue') || '[]')
            const finalQueueData = updatedQueueData.map(queueItem => {
              if (queueItem.id === item.id) {
                return {
                  ...queueItem,
                  status: 'done',
                  completedAt: new Date().toISOString()
                }
              }
              return queueItem
            })
            localStorage.setItem('offline_queue', JSON.stringify(finalQueueData))
            
            addDetailedLog('QUEUE', 'response', 'SUCCESS', 'SUCCESS', `id=${item.id}, status=200, ms=${duration}`)
          } else {
            // Hata t√ºr√ºne g√∂re ayrƒ±≈ütƒ±r
            if (response.status >= 500) {
              // 5xx - Sunucu hatasƒ±, retry edilebilir ‚Üí queued
              const updatedQueueData = JSON.parse(localStorage.getItem('offline_queue') || '[]')
              const finalQueueData = updatedQueueData.map(queueItem => {
                if (queueItem.id === item.id) {
                  return {
                    ...queueItem,
                    status: 'queued',
                    retryCount: (queueItem.retryCount || 0) + 1
                  }
                }
                return queueItem
              })
              localStorage.setItem('offline_queue', JSON.stringify(finalQueueData))
              
              failedItems.push({ ...item, status: 'retry', error: result.error, retryCount: 0 })
              addDetailedLog('QUEUE', 'response', 'FAILED', 'FAILED', `id=${item.id}, status=5xx, ms=${duration}`)
            } else if (response.status >= 400) {
              // 4xx - Ge√ßersiz kayƒ±t, retry edilmez ‚Üí failed
              failCount++
              const updatedQueueData = JSON.parse(localStorage.getItem('offline_queue') || '[]')
              const finalQueueData = updatedQueueData.map(queueItem => {
                if (queueItem.id === item.id) {
                  return {
                    ...queueItem,
                    status: 'failed',
                    error: result.error
                  }
                }
                return queueItem
              })
              localStorage.setItem('offline_queue', JSON.stringify(finalQueueData))
              
              addDetailedLog('QUEUE', 'response', 'FAILED', 'FAILED', `id=${item.id}, status=4xx, ms=${duration}`)
            } else {
              // Diƒüer hatalar ‚Üí failed
              failCount++
              const updatedQueueData = JSON.parse(localStorage.getItem('offline_queue') || '[]')
              const finalQueueData = updatedQueueData.map(queueItem => {
                if (queueItem.id === item.id) {
                  return {
                    ...queueItem,
                    status: 'failed',
                    error: result.error
                  }
                }
                return queueItem
              })
              localStorage.setItem('offline_queue', JSON.stringify(finalQueueData))
              
              addDetailedLog('QUEUE', 'response', 'FAILED', 'FAILED', `id=${item.id}, status=other, ms=${duration}`)
            }
          }
        } catch (error) {
          const duration = Date.now() - startTime
          // Aƒü hatasƒ± - retry edilebilir ‚Üí queued
          const updatedQueueData = JSON.parse(localStorage.getItem('offline_queue') || '[]')
          const finalQueueData = updatedQueueData.map(queueItem => {
            if (queueItem.id === item.id) {
              return {
                ...queueItem,
                status: 'queued',
                retryCount: (queueItem.retryCount || 0) + 1
              }
            }
            return queueItem
          })
          localStorage.setItem('offline_queue', JSON.stringify(finalQueueData))
          
          failedItems.push({ ...item, status: 'retry', error: error.message, retryCount: 0 })
          addDetailedLog('QUEUE', 'response', 'FAILED', 'FAILED', `id=${item.id}, status=network, ms=${duration}`)
        }
      }

      // Saya√ßlarƒ± depodan g√ºncelle
      await updateCountersFromStorage()
      
      // Ba≈üarƒ±lƒ± sonu√ßlarƒ± i≈üle
      if (successCount > 0) {
        showSuccess(`Kuyruk i≈ülendi: ${successCount} ba≈üarƒ±lƒ±, ${failCount} ba≈üarƒ±sƒ±z`)
        updateDashboard(successCount, failCount)
      }

      // Retry edilebilir √∂ƒüeler varsa retry ba≈ülat
      if (failedItems.length > 0) {
        addDetailedLog('QUEUE', 'retryStart', 'RUNNING', 'SUCCESS', `retryable=${failedItems.length}, failed=${failCount}`)
        scheduleRetry(failedItems, 1)
        return // Worker durumu retry tamamlanana kadar running kalacak
      }

      // T√ºm i≈ülemler tamamlandƒ±
      setWorkerState('idle') // Worker durumunu idle yap
      addDetailedLog('QUEUE', 'done', 'SUCCESS', 'SUCCESS', `ƒ∞≈ülem tamamlandƒ±`)
      
      if (successCount === 0 && failCount > 0) {
        showError('T√ºm kayƒ±tlar ba≈üarƒ±sƒ±z oldu')
      }
      
    } catch (error) {
      addDetailedLog('QUEUE', 'processError', 'FAILED', 'FAILED', error.message)
      
      // Sebep bazlƒ± hata mesajlarƒ±
      if (error.message.includes('Worker zaten √ßalƒ±≈üƒ±yor')) {
        showError('ƒ∞≈ülem zaten devam ediyor - bekleyin')
      } else if (error.message.includes('Offline a√ßƒ±kken')) {
        showError('Offline a√ßƒ±kken i≈üleme yapƒ±lamaz')
      } else if (error.message.includes('ƒ∞≈ülenecek kayƒ±t yok')) {
        showInfo('ƒ∞≈ülenecek kayƒ±t yok')
      } else {
        showError(`Sistem hatasƒ±: ${error.message}`)
      }
      
      // Hata durumunda saya√ßlarƒ± sƒ±fƒ±rla
      setP(0)
      setQ(queueItems.length) // Kuyruƒüu geri y√ºkle
    } finally {
      // Worker durumunu idle yap
      setWorkerState('idle')
      addDetailedLog('QUEUE', 'workerComplete', 'SUCCESS', 'SUCCESS', 'Worker tamamlandƒ±')
    }
  }

  // D) Kuyruƒüu Temizle - SPESƒ∞Fƒ∞KASYON
  const handleClearQueue = () => {
    console.log(`üîÑ D) Kuyruƒüu Temizle: Q=${Q}, P=${P}`)

    if (Q === 0) {
      showInfo('‚ÑπÔ∏è Kuyruk zaten bo≈ü')
      return
    }
    
    // Onay modalƒ± g√∂ster
    setShowClearModal(true)
  }

  const confirmClearQueue = async () => {
    console.log(`üîÑ D) Onaylandƒ±: Q=${Q}, P=${P}`)

    // Kuyruk=0, ƒ∞≈üleniyor=0, Toplam deƒüi≈ümez (spesifikasyona g√∂re)
    // Depodan queued ve processing kayƒ±tlarƒ± temizle
    const queueData = JSON.parse(localStorage.getItem('offline_queue') || '[]')
    const filteredData = queueData.filter(item => 
      item.status !== 'queued' && item.status !== 'processing'
    )
    localStorage.setItem('offline_queue', JSON.stringify(filteredData))
    
    // Saya√ßlarƒ± depodan g√ºncelle
    await updateCountersFromStorage()
    
    // UI i√ßin g√ºncelle
    setQueueItems([])
    
    showSuccess('Kuyruk ba≈üarƒ±yla temizlendi.')

    setShowClearModal(false)
  }

  // Appium baƒülantƒ± kontrol√º kaldƒ±rƒ±ldƒ± - artƒ±k kontrol edilmiyor

  // RunId'yi URL'den veya localStorage'dan al
  useEffect(() => {
    // URL'den runId al (query parameter)
    const urlParams = new URLSearchParams(window.location.search)
    const runIdFromUrl = urlParams.get('runId')
    
    if (runIdFromUrl) {
      setCurrentRunId(runIdFromUrl)
      addEventLog(`RunId alƒ±ndƒ±: ${runIdFromUrl}`, 'info')
    } else {
      // localStorage'dan al
      const savedRunId = localStorage.getItem('currentRunId')
      if (savedRunId) {
        setCurrentRunId(savedRunId)
        addEventLog(`RunId localStorage'dan alƒ±ndƒ±: ${savedRunId}`, 'info')
      }
    }
    
    // Uzla≈üma sistemi - takƒ±lƒ± processing √∂ƒüeleri temizle
    reconcileProcessingItems()
    
    // Saya√ßlarƒ± depodan g√ºncelle
    updateCountersFromStorage()
  }, [])

  // Baƒülantƒ± durumu kontrol√º kaldƒ±rƒ±ldƒ±
  useEffect(() => {
    addEventLog('Mobil test ekranƒ± a√ßƒ±ldƒ±', 'info')
    
    // Web testi tamamlandƒ±ƒüƒ±nda dinle
    const handleWebTestCompleted = (event) => {
      onWebTestCompleted(event.detail.success)
    }
    
    document.addEventListener('webTestCompleted', handleWebTestCompleted)
    
    return () => {
      document.removeEventListener('webTestCompleted', handleWebTestCompleted)
      
      // Retry zamanlayƒ±cƒ±sƒ±nƒ± temizle
      if (queueRetrySchedule) {
        clearTimeout(queueRetrySchedule)
        setQueueRetrySchedule(null)
      }
    }
  }, [queueRetrySchedule])

  return (
    <div className="mobile-page">
      {/* Professional Form Header */}
      <div className="form-header">
        <h1 className="form-title" data-testid="mobile-barcode-title">Barkod Sim√ºlasyonu</h1>
        <p className="form-subtitle">Test barkodlarƒ± √ºretin ve sonu√ßlarƒ± g√∂r√ºn</p>
        </div>

      {/* Toggle Container - Basit */}
        <div style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          padding: '20px',
          background: 'rgba(255, 255, 255, 0.95)',
          margin: '20px 20px 24px 20px',
          borderRadius: '12px',
          boxShadow: '0 2px 8px rgba(0, 0, 0, 0.06)'
        }}>
          <span style={{
            fontSize: '16px',
            fontWeight: '600',
            color: '#374151'
          }}>Offline Modu</span>
          
          <div 
              onClick={handleOfflineModeToggle}
            style={{
              position: 'relative',
              width: '52px',
              height: '28px',
              borderRadius: '14px',
              backgroundColor: offline ? '#28a745' : '#cccccc',
              cursor: 'pointer',
              transition: 'background-color 0.3s ease'
            }}
          >
            <div style={{
              position: 'absolute',
              top: '2px',
              left: offline ? '26px' : '2px',
              width: '24px',
              height: '24px',
              background: 'white',
              borderRadius: '50%',
              transition: 'left 0.3s ease',
              boxShadow: '0 2px 6px rgba(0, 0, 0, 0.3)'
            }}></div>
          </div>
        </div>
      
      {/* Kontrol Paneli - 3 Kutucuk */}
      <div className="mobile-control-stats">
        <div className="mobile-stat-box">
          <div className="mobile-stat-number">{Q}</div>
          <div className="mobile-stat-title">Kuyruk</div>
        </div>
        <div className="mobile-stat-box">
          <div className="mobile-stat-number">{P}</div>
          <div className="mobile-stat-title">ƒ∞≈üleniyor</div>
        </div>
        <div className="mobile-stat-box">
          <div className="mobile-stat-number">{T}</div>
          <div className="mobile-stat-title">Toplam</div>
        </div>
      </div>

      {/* Aksiyon Butonlarƒ± - Etkinlik Matrisi Uygulandƒ± */}
      <div className="mobile-action-section">
        {/* Barkod Tara: Sim√ºlasyon paneli a√ßar */}
        <button
          className="mobile-action-btn mobile-action-primary"
          onClick={openSimulationPanel}
          title="Barkod sim√ºlasyonu panelini a√ßar"
        >
          Barkod Tara / Oku
        </button>
        
        {/* Kuyruƒüu ƒ∞≈üle: Online + Q>0 + worker=idle iken aktif */}
        <button
          className={`mobile-action-btn mobile-action-secondary ${
            offline || Q === 0 || workerState !== 'idle' ? 'disabled' : ''
          }`}
          onClick={handleProcessQueue}
          disabled={offline || Q === 0 || workerState !== 'idle'}
          title={
            offline
              ? 'Offline a√ßƒ±kken i≈üleme yapƒ±lamaz' 
              : Q === 0
                ? 'ƒ∞≈ülenecek kayƒ±t yok'
                : workerState !== 'idle'
                  ? 'ƒ∞≈ülem devam ediyor'
                  : 'Kuyruktaki barkodlarƒ± i≈üle'
          }
        >
          {workerState !== 'idle' ? 'ƒ∞≈üleniyor‚Ä¶' : 'Kuyruƒüu ƒ∞≈üle'}
        </button>
        
        {/* Kuyruƒüu Temizle: Q>0 ve worker=idle iken aktif */}
        <button
          className={`mobile-action-btn mobile-action-danger ${
            Q === 0 || workerState !== 'idle' ? 'disabled' : ''
          }`}
          onClick={handleClearQueue}
          disabled={Q === 0 || workerState !== 'idle'}
          title={
            Q === 0
                ? 'Kuyruk bo≈ü - temizlenecek barkod yok'
                : workerState !== 'idle'
                  ? 'ƒ∞≈ülem devam ediyor - bekleyin'
                  : `${Q} barkod var - kuyruƒüu temizle`
          }
        >
          Kuyruƒüu Temizle
        </button>
      </div>
          
      {/* Test Barkodlarƒ± Listesi kaldƒ±rƒ±ldƒ± - tek kaynak modal */}

      {/* Manuel Giri≈ü kaldƒ±rƒ±ldƒ± - tek kaynak modal */}


      {/* Senaryo Adƒ±mlarƒ± */}
      <div className="mobile-scenario-section">
        <h3>Senaryo Adƒ±mlarƒ±</h3>
        <div className="mobile-scenario-accordion">
          
                <div className="mobile-accordion-item">
                  <button 
                    className="mobile-accordion-header"
                    onClick={() => setExpandedStep(expandedStep === 1 ? null : 1)}
                    aria-expanded={expandedStep === 1}
              aria-controls="step-1-content"
                  >
                    <div className="mobile-step-badge">1</div>
              <div className="mobile-step-title">Offline modu aktif edin</div>
                    <div className="mobile-accordion-chevron">
                      {expandedStep === 1 ? '‚ñ≤' : '‚ñº'}
            </div>
                  </button>
                  {expandedStep === 1 && (
              <div id="step-1-content" className="mobile-accordion-content">
                <p>Toggle ile offline modu a√ßƒ±n. Bu modda barkodlar kuyruƒüa eklenir.</p>
        </div>
                  )}
      </div>

                <div className="mobile-accordion-item">
                  <button 
                    className="mobile-accordion-header"
                    onClick={() => setExpandedStep(expandedStep === 2 ? null : 2)}
                    aria-expanded={expandedStep === 2}
              aria-controls="step-2-content"
                  >
                    <div className="mobile-step-badge">2</div>
              <div className="mobile-step-title">Bir barkod se√ßin veya girin</div>
                    <div className="mobile-accordion-chevron">
                      {expandedStep === 2 ? '‚ñ≤' : '‚ñº'}
              </div>
                  </button>
                  {expandedStep === 2 && (
              <div id="step-2-content" className="mobile-accordion-content">
                <p>Test barkodlarƒ±ndan birini tƒ±klayƒ±n veya manuel giri≈ü yapƒ±n.</p>
                </div>
              )}
            </div>

                <div className="mobile-accordion-item">
                  <button 
                    className="mobile-accordion-header"
                    onClick={() => setExpandedStep(expandedStep === 3 ? null : 3)}
                    aria-expanded={expandedStep === 3}
              aria-controls="step-3-content"
                  >
                    <div className="mobile-step-badge">3</div>
              <div className="mobile-step-title">Barkod kuyruƒüa eklenir</div>
                    <div className="mobile-accordion-chevron">
                      {expandedStep === 3 ? '‚ñ≤' : '‚ñº'}
        </div>
                  </button>
                  {expandedStep === 3 && (
              <div id="step-3-content" className="mobile-accordion-content">
                <p>Kuyruk sayacƒ± artar ve barkod beklemeye alƒ±nƒ±r.</p>
                    </div>
                  )}
      </div>

                <div className="mobile-accordion-item">
        <button
                    className="mobile-accordion-header"
                    onClick={() => setExpandedStep(expandedStep === 4 ? null : 4)}
                    aria-expanded={expandedStep === 4}
              aria-controls="step-4-content"
                  >
                    <div className="mobile-step-badge">4</div>
              <div className="mobile-step-title">"Kuyruƒüu ƒ∞≈üle" butonuna tƒ±klayƒ±n</div>
                    <div className="mobile-accordion-chevron">
                      {expandedStep === 4 ? '‚ñ≤' : '‚ñº'}
                    </div>
        </button>
                  {expandedStep === 4 && (
              <div id="step-4-content" className="mobile-accordion-content">
                <p>√ñnce online moda ge√ßin. Kuyruktaki barkodlarƒ± i≈üleyin. ƒ∞≈üleniyor sayacƒ± ge√ßici olarak artar.</p>
                    </div>
                  )}
                </div>

                <div className="mobile-accordion-item">
                  <button 
                    className="mobile-accordion-header"
                    onClick={() => setExpandedStep(expandedStep === 5 ? null : 5)}
                    aria-expanded={expandedStep === 5}
              aria-controls="step-5-content"
                  >
                    <div className="mobile-step-badge">5</div>
              <div className="mobile-step-title">Kuyruk i≈ülenir ve temizlenir</div>
                    <div className="mobile-accordion-chevron">
                      {expandedStep === 5 ? '‚ñ≤' : '‚ñº'}
                    </div>
                  </button>
                  {expandedStep === 5 && (
              <div id="step-5-content" className="mobile-accordion-content">
                <p>Toplam sayacƒ± g√ºncellenir ve kuyruk temizlenir.</p>
                    </div>
                  )}
            </div>

          </div>
      </div>

      {/* Mobil Test Butonlarƒ± */}
      <div className="mobile-complete-section">
        {/* Mobil Test Ba≈ülat Butonu */}
        {testPhase === 'MOBILE_READY' && (
        <button
            className="mobile-complete-btn mobile-start-btn"
            onClick={handleMobileTestStart}
            disabled={isMobileTestRunning}
          >
            {isMobileTestRunning ? 'Mobil Test √áalƒ±≈üƒ±yor...' : 'Mobil Testini Ba≈ülat'}
          </button>
        )}

        {/* Mobil Test Durumu */}
        {isMobileTestRunning && (
          <div className="mobile-test-status">
            <h4>Mobil Test Durumu</h4>
            <div className="test-phase">Faz: {testPhase}</div>
            <div className="test-step">Adƒ±m: {mobileStep}</div>
            <div className="test-status">Durum: {mobileStepStatus}</div>
            {mobileStepError && (
              <div className="test-error">Hata: {mobileStepError}</div>
            )}
          </div>
        )}

        {/* Mobil Test Bitir Butonu */}
        {(testPhase === 'MOBILE_SUCCESS' || testPhase === 'MOBILE_FAILED') && (
          <button
            className={`mobile-complete-btn ${
              testPhase === 'MOBILE_SUCCESS' ? 'mobile-success-btn' : 'mobile-error-btn'
            }`}
          onClick={handleMobileTestComplete}
        >
            {testPhase === 'MOBILE_SUCCESS' 
              ? 'Mobil Testini Bitir' 
              : 'Testi Sonlandƒ±r (Hata var)'
            }
        </button>
        )}

        {/* Test Sƒ±fƒ±rla Butonu */}
        {testPhase === 'FINISHED' && (
          <button
            className="mobile-complete-btn mobile-reset-btn"
            onClick={() => {
              setTestPhase('IDLE')
              setMobileStep(0)
              setMobileStepStatus('')
              setMobileStepError('')
              setIsMobileTestRunning(false)
              setSelectedBarcode('')
              setInitialOfflineState(false)
              showInfo('Test sƒ±fƒ±rlandƒ±')
            }}
          >
            Testi Sƒ±fƒ±rla
          </button>
        )}
      </div>

      {/* Kuyruƒüu Temizle Modal - Mobil Optimize */}
      {showClearModal && (
        <div className="mobile-modal-overlay" onClick={() => setShowClearModal(false)}>
          <div className="mobile-modal-content" onClick={(e) => e.stopPropagation()}>
            <div className="mobile-modal-header">
              <h3 className="mobile-modal-title">Kuyruƒüu Temizle</h3>
            </div>
            
            <div className="mobile-modal-body">
              <p className="mobile-modal-text">
                Kuyrukta {Q} kayƒ±t var. Bu i≈ülem geri alƒ±namaz. Devam etmek istiyor musunuz?
              </p>
              </div>
              
            <div className="mobile-modal-buttons">
                <button
                className="mobile-modal-btn mobile-modal-btn-secondary"
                onClick={() => setShowClearModal(false)}
              >
                Vazge√ß
                </button>
                <button
                className="mobile-modal-btn mobile-modal-btn-danger"
                onClick={confirmClearQueue}
              >
                Evet, Temizle
                </button>
              </div>
          </div>
        </div>
      )}

      {/* Barkod Sim√ºlasyon Paneli */}
      {showSimulationPanel && (
        <div className="mobile-modal-overlay" onClick={closeSimulationPanel}>
          <div className="mobile-modal-content simulation-panel" onClick={(e) => e.stopPropagation()}>
            <div className="mobile-modal-header">
              <h3 className="mobile-modal-title">Barkod Sim√ºlasyonu</h3>
              <button 
                className="mobile-modal-close"
                onClick={closeSimulationPanel}
              >
                √ó
              </button>
            </div>
            
            <div className="mobile-modal-body">
              {/* Rastgele Ge√ßerli Barkod √úret */}
              <div className="simulation-option">
                <button
                  className="mobile-action-btn mobile-action-primary"
                  onClick={handleGenerateValid}
                >
                  Ge√ßerli Barkod √úret
                </button>
                <p className="simulation-description">
                  Rastgele ge√ßerli format barkod √ºretir
                </p>
              </div>

              {/* Rastgele Ge√ßersiz Barkod √úret */}
              <div className="simulation-option">
                <button
                  className="mobile-action-btn mobile-action-secondary"
                  onClick={handleGenerateInvalid}
                >
                  Ge√ßersiz Barkod √úret
                </button>
                <p className="simulation-description">
                  Negatif test i√ßin ge√ßersiz barkod √ºretir
                </p>
              </div>

              {/* Hazƒ±r Barkod Listesi */}
              <div className="simulation-option">
                <h4>Hazƒ±r Barkodlardan Se√ß</h4>
                <div className="predefined-barcodes">
                  {getPredefinedBarcodes().map((item, index) => (
                    <button
                      key={index}
                      className={`predefined-barcode ${item.valid ? 'valid' : 'invalid'}`}
                      onClick={() => handleSelectPredefined(item.code)}
                    >
                      <span className="barcode-type">{item.type}</span>
                      <span className="barcode-code">{item.code}</span>
                    </button>
                  ))}
                </div>
              </div>

              {/* Manuel Giri≈ü */}
              <div className="simulation-option">
                <h4>Manuel Giri≈ü</h4>
                <div className="manual-input-group">
                  <input
                    type="text"
                    value={simulationInput}
                    onChange={(e) => setSimulationInput(e.target.value.toUpperCase())}
                    placeholder="Barkod giriniz (√∂rn: ULD-AKE12345AB)"
                    className="manual-barcode-input"
                    onKeyDown={(e) => {
                      if (e.key === 'Enter') {
                        e.preventDefault()
                        handleManualSubmit()
                      }
                    }}
                  />
                  {simulationError && (
                    <div className="simulation-error">{simulationError}</div>
                  )}
                  <button
                    className="mobile-action-btn mobile-action-primary"
                    onClick={handleManualSubmit}
                    disabled={!simulationInput.trim()}
                  >
                    Ekle
                  </button>
                </div>
              </div>
              </div>
          </div>
        </div>
      )}

    </div>
  )
}

export default MobileBarcode